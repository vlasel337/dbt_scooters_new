version: 2

macros:
  - name: "updated_at"
    description: "Columns which represents timestamp of the last update"
  - name: "date_in_moscow"
    description: "Ð¡onvert timestamptz to date in Europe/Moscow timezone (UTC+3)"
    arguments:
      - name: "ts_col"
        type: "string"
        description: "Timestamp column in timestampz format"

sources:
  - name: "scooters_raw" 
    description: "Raw data provided by scooters service (the name of the scheme)"
    loader: "https://t.me/inzhenerka_dbt_bot"
    tables:
      - name: "trips"
        description: "Scooter trips"

      - name: "users"
        description: "Users of scooter service"

      - name: "events"
        description: "Raw user events with duplicates"


seeds:
  - name: "scooters"
    description: "Dictionary with scooters models"
    config:
      delimeter: ","
  - name: "event_types"
    description: "Dictionary with mobile app event types"
    config:
      delimeter: ","
  - name: "age_groups"
    description: "Age groups to split users for analysis"
      

models:
  - name: "trips_prep"
    description: "Tuned trips view"
    config:
      materialized: view
  - name: "trips_stat"
    description: "Overall trips statistics"
  - name: "trips_stat_daily"
    description: "Daily trips statistics"
    config:
      indexes:
        - columns: ["date"]
  - name: "trips_age_daily"
    description: "Daily trips statistics by user age"
  - name: "trips_age_daily_stat"
    description: "Aggregation of daily trips statistics by user age"
  - name: "trips_users"
    description: "Rides enriched with users personal data"
    config:
      materialized: "incremental"
  - name: "events_clean"
    description: "Dedublicated events table"
    config:
      materialized: "incremental"
      strategie: "merge"
      unique_key: ["user_id","timestamp","type_id"]

  - name: "revenue_daily"
    description: "Daily revenue aggregate"
    config:
      materialized: "incremental"
      full_refresh: false
      strategy: "merge"
      unique_key: [date]
      on_schema_change: "append_new_columns"
  - name: "trips_concurrency"
    description: "Number of simultaneous rides in time"
    config:
      materialized: "incremental"
  - name: "companies"
    description: "Models quantity by companies"
  - name: "companies_trips"
    description: "Number of trips by companies"
  - name: "events_full"
    description: "View with dedublicated events enriched with meaningful types" 
    config:
      materialized: "view"
  - name: "events_stat"
    description: "Percent of cancelled orders" 
  - name: "trips_age_group"
    description: "Overall trips statistics by user age group"

      

    


    

      

  
      


      

      

    


  

      