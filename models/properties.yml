version: 2

macros:
  - name: "updated_at"
    description: "Columns which represents timestamp of the last update"
  - name: "date_in_moscow"
    description: "Ð¡onvert timestamptz to date in Europe/Moscow timezone (UTC+3)"
    arguments:
      - name: "ts_col"
        type: "string"
        description: "Timestamp column in timestampz format"
  - name: "create_role"
    description: "Create role for users as dbt operation"
    arguments:
      - name: "name"
        type: "string"
        description: "Role name"


      
sources:
  - name: "scooters_raw" 
    description: "Raw data provided by scooters service (the name of the scheme)"
    loader: "https://t.me/inzhenerka_dbt_bot"
    tables:
      - name: "trips"
        description: "Scooter trips"
        loaded_at_field: "finished_at"
        config:
          freshness:
            warn_after:
              count: 1
              period: "day"
            error_after:
              count: 3650
              period: "day"
        columns:
          - name: "user_id"
            data_tests:
              - not_null
              - relationships:
                  name: "every_trip_has_user"
                  to: "source('scooters_raw', 'users')"
                  field: "id"

      - name: "users"
        description: "Users of scooter service"
        columns:
          - name: "sex"
            description: "User gender"
            data_tests:
              - accepted_values:
                  values: ["M","F"]
              - not_null:
                  config:
                    severity: "warn"

      - name: "events"
        description: "Raw user events with duplicates"


seeds:
  - name: "scooters"
    description: "Dictionary with scooters models"
    config:
      delimeter: ","
  - name: "event_types"
    description: "Dictionary with mobile app event types"
    config:
      delimeter: ","
  - name: "age_groups"
    description: "Age groups to split users for analysis"
      

models:
  - name: "trips_prep"
    description: "Tuned trips view"
    config:
      materialized: view
  - name: "trips_stat"
    description: "Overall trips statistics"
  - name: "trips_stat_daily"
    description: "Daily trips statistics"
    config:
      indexes:
        - columns: ["date"]
  - name: "trips_age_daily"
    description: "Daily trips statistics by user age"
    data_tests:
      - unique:
          column_name: "date::text || age::text"

  - name: "trips_age_daily_stat"
    description: "Aggregation of daily trips statistics by user age"
  - name: "trips_users"
    description: "Rides enriched with users personal data"
    config:
      materialized: "incremental"
      post-hook:
        - "analyze dbt.trips_users"
        - sql: "vacuum dbt.trips_users"
          transaction: false

  - name: "events_clean"
    description: "Dedublicated events table"
    config:
      materialized: "incremental"
      strategie: "merge"
      unique_key: ["user_id","timestamp","type_id"]


  - name: "trips_concurrency"
    description: "Number of simultaneous rides in time"
    config:
      materialized: "incremental"
  - name: "companies"
    description: "Models quantity by companies"
  - name: "companies_trips"
    description: "Number of trips by companies"
    columns:
      - name: "company"
        data_tests:
          - unique
  - name: "events_full"
    description: "View with dedublicated events enriched with meaningful types" 
    config:
      materialized: "view"
  - name: "events_stat"
    description: "Percent of cancelled orders" 
  - name: "trips_age_group"
    description: "Overall trips statistics by user age group"
  - name: "trips_by_user"
    description: "Trips can be updated by special user"
    config:
      materialized: "incremental"

      

    


    

      

  
      


      

      

    


  

      